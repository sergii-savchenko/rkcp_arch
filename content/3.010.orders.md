## Orders

### Create new order

```mermaid
sequenceDiagram
    participant User
    participant Proxy
    participant AppLogic
    participant Peatio
    participant RabbitMQ
    participant PeatioDaemons
    participant Db
    participant Vault
    participant Notifications

    PeatioDaemons->>RabbitMQ: [subscribe default channel (queues: matching, new_trade, order_processor)]
    PeatioDaemons->>RabbitMQ: [subscribe orderbook channel]
    PeatioDaemons->>RabbitMQ: [subscribe trade channel]
    User->>Proxy: request POST '{APPLOGIC}/api/v1/orders/new'
    Proxy->>AppLogic: redirect POST '{APPLOGIC}/api/v1/orders/new'
    Note over AppLogic: verify JWT (see JWT verification)
    AppLogic->>Peatio: request POST '{PEATIO}/api/v2/orders/'
    Note over Peatio: verify JWT
    Peatio->>+Db: save order
    Peatio->>Db: lock funds (change account balance)
    Db-->>-Peatio: result
    alt success
        Peatio->>RabbitMQ: [in default channel publish action:submit order to the matching queue]
        opt daemons worker
            RabbitMQ-->>PeatioDaemons: [receive data from default channel]
            PeatioDaemons->>RabbitMQ: [in orderbook channel publish action:new marketID+sell/marketId+buy]
            RabbitMQ-->>PeatioDaemons: [receive data from orderbook channel]
            PeatioDaemons->>RabbitMQ: [in default channel publish action:submit order to the matching new_trade, order_processor]
            PeatioDaemons-->>PeatioDaemons: calculate
            PeatioDaemons->>Db: save data
        end
        Peatio-->>AppLogic: response new order JSON
    else fail
        Peatio-->>AppLogic: cannot create
    end
    AppLogic-->>Proxy: Response
    Proxy-->>User: Response
```

### Delete order

```mermaid
sequenceDiagram
    participant User
    participant Proxy
    participant AppLogic
    participant Peatio
    participant PeatioDaemons
    participant RabbitMQ
    participant Db
    participant Vault
    participant Notifications

    User->>Proxy: request POST '{APPLOGIC}/api/v1/orders/delete'
    Proxy->>AppLogic: redirect POST '{APPLOGIC}/api/v1/orders/delete'
    Note over AppLogic: verify JWT (see JWT verification)
    AppLogic->>Peatio: request POST '{PEATIO}/api/v2/order/delete'
    Note over Peatio: verify JWT
    Peatio->>Db: canceled order
    Peatio->>RabbitMQ: publish canceling
    RabbitMQ-->>PeatioDaemons: Receive notification in subscribing channel

    Peatio-->>AppLogic: Response result

    AppLogic-->>Proxy: Response
    Proxy-->>User: Response
```